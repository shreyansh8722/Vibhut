import{c as M,n as K,b as ee,a as te,r,i as H,e as S,h as se,d as z,j as e,o as E,R as B,k as ae,x as le,g as re,_ as V,F as ne,U as G,z as oe,y as ie,B as ce,C as de,D as me,E as ue}from"./index-fYIJ22hC.js";import{m as P}from"./proxy-Cxc5Icpb.js";import{A as xe}from"./arrow-left-C7VSTNop.js";import{X as O}from"./x-CrMldECL.js";import{A as he}from"./index-BJlB8vhG.js";import{S as W}from"./star-B-XdTAma.js";import{C as ge}from"./check-B_CjT2rm.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],pe=M("camera",fe);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M18 20a6 6 0 0 0-12 0",key:"1qehca"}],["circle",{cx:"12",cy:"10",r:"4",key:"1h16sb"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],we=M("circle-user-round",ye);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],ve=M("message-square",be);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Ne=M("plus",je);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],Re=M("thumbs-up",ke);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Se=M("trash-2",Ce);function Ae(t){if(!t)return"";try{const l=t.toDate?t.toDate():new Date(t),i=(Date.now()-l.getTime())/1e3;return i<60?"Just now":i<3600?`${Math.floor(i/60)}m ago`:i<86400?`${Math.floor(i/3600)}h ago`:i<604800?`${Math.floor(i/86400)}d ago`:l.toLocaleDateString()}catch{return""}}function Me(t,l){return t||(l?l.split("@")[0]:"Anonymous")}const I=()=>e.jsxs("div",{className:"bg-white p-4 rounded-2xl shadow-sm border border-gray-100 animate-pulse",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/4 bg-gray-200 rounded"}),e.jsx("div",{className:"h-3 w-1/2 bg-gray-200 rounded"})]}),e.jsx("div",{className:"h-4 w-1/4 bg-gray-200 rounded"})]}),e.jsx("div",{className:"h-3 w-full bg-gray-200 rounded mt-4"}),e.jsx("div",{className:"h-3 w-5/6 bg-gray-200 rounded mt-1.5"}),e.jsx("div",{className:"h-32 w-full bg-gray-200 rounded-lg mt-3"}),e.jsxs("div",{className:"flex justify-between mt-3",children:[e.jsx("div",{className:"h-6 w-20 bg-gray-200 rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-gray-200 rounded-full"})]})]}),De=r.memo(({review:t,user:l,onDeleteReview:i,onMarkHelpful:b})=>{const A=Me(t.username,t.userEmail),[p,v]=r.useState(!1),[c,g]=r.useState(!1),[f,j]=r.useState(t.helpfulCount||0),[h,N]=r.useState(!1),D=l&&t.userId===l.uid,_=()=>{v(!0),i(t.id,t.rating,t.imageUrl)},n=async()=>{if(!l||h||c)return;g(!0);const d=await b(t.id,l.uid);g(!1),d&&(N(!0),j(m=>m+1))};return e.jsxs(P.div,{layout:!0,initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,x:-50},transition:{duration:.22},className:"bg-white p-4 rounded-2xl shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(we,{className:"w-10 h-10 text-gray-400 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-800",children:A}),e.jsx("div",{className:"text-xs text-gray-400",children:Ae(t.createdAt)})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:5}).map((d,m)=>e.jsx(W,{className:`w-4 h-4 ${m<(t.rating||0)?"fill-yellow-400 text-yellow-400":"text-gray-300"}`},m))})]}),e.jsx("p",{className:"text-gray-700 text-sm leading-snug",children:t.comment}),t.imageUrl&&e.jsx("div",{className:"mt-3",children:e.jsx("img",{src:t.imageUrl,alt:"Review attachment",className:"w-full h-44 object-cover rounded-lg border border-gray-100",loading:"lazy"})}),e.jsxs("div",{className:"mt-4 pt-3 border-t border-gray-100 flex items-center justify-between",children:[e.jsxs("button",{onClick:n,disabled:!l||h||c,className:`text-sm font-medium flex items-center gap-1.5 px-3 py-1 rounded-full transition-colors ${h?"bg-green-100 text-green-700 cursor-default":"bg-gray-100 text-gray-600 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed"}`,children:[c?e.jsx(E,{className:"w-4 h-4 animate-spin"}):h?e.jsx(ge,{className:"w-4 h-4"}):e.jsx(Re,{className:"w-4 h-4"}),"Helpful ",f>0?`(${f})`:""]}),D&&e.jsxs("button",{onClick:_,disabled:p,className:"text-sm text-red-600 font-medium flex items-center gap-1 hover:text-red-800 disabled:text-gray-400",children:[p?e.jsx(E,{className:"w-4 h-4 animate-spin"}):e.jsx(Se,{className:"w-4 h-4"}),p?"Deleting...":"Delete"]})]})]})}),_e=({spotId:t,user:l,onPostSuccess:i,isPosting:b,setIsPosting:A})=>{const[p,v]=r.useState(5),[c,g]=r.useState(""),[f,j]=r.useState(null),[h,N]=r.useState(0),D=n=>new Promise((d,m)=>{const C=`${Date.now()}_${n.name.replace(/\s+/g,"_")}`,y=`reviews/${t}/${C}`,k=ce(ue,y),w=de(k,n);w.on("state_changed",u=>{const R=u.bytesTransferred/u.totalBytes*100;N(R)},u=>m(u),async()=>{const u=await me(w.snapshot.ref);d(u)})}),_=async()=>{if(!(!l||!c.trim())){A(!0),N(0);try{let n=null;f&&(n=await D(f));const d={spotId:t,userId:l.uid,username:l.displayName||l.email||"Anonymous",userEmail:l.email,rating:p,comment:c.trim(),imageUrl:n||null,helpfulCount:0,createdAt:ie()},m=H(S,"spots",t),C=H(V(S,"reviews"));await G(S,async y=>{const k=await y.get(m);if(!k.exists())throw"Spot document does not exist!";const w=k.data().reviewCount||0,u=k.data().averageRating||0,R=w+1,U=(u*w+p)/R;y.set(C,d),y.update(m,{averageRating:parseFloat(U.toFixed(1)),reviewCount:R})}),v(5),g(""),j(null),N(0),i(d,C.id)}catch(n){console.error("Failed to post review:",n)}finally{A(!1)}}};return e.jsxs(P.div,{className:"bg-white p-4 shadow-sm",initial:{y:-50,opacity:0},animate:{y:0,opacity:1},exit:{y:-50,opacity:0},transition:{type:"tween",ease:"easeOut",duration:.3},children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[Array.from({length:5}).map((n,d)=>e.jsx("button",{onClick:()=>v(d+1),className:"focus:outline-none",children:e.jsx(W,{className:`w-6 h-6 ${d+1<=p?"fill-yellow-400 text-yellow-400":"text-gray-300"}`})},d+1)),e.jsxs("span",{className:"text-sm text-gray-600 ml-2",children:[p," / 5"]})]}),e.jsx("textarea",{rows:3,className:"w-full border border-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-black outline-none mb-3",placeholder:"Share your experience...",value:c,onChange:n=>g(n.target.value)}),f&&!b&&e.jsxs("div",{className:"mb-3 relative",children:[e.jsx("img",{src:URL.createObjectURL(f),alt:"preview",className:"w-full h-44 object-cover rounded-lg"}),e.jsx("button",{onClick:()=>j(null),className:"absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full","aria-label":"Remove image",children:e.jsx(O,{className:"w-4 h-4"})})]}),b&&h>0&&e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mb-3",children:e.jsx("div",{className:"bg-black h-1.5 rounded-full",style:{width:`${h}%`}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-sm text-gray-600 hover:text-black",children:[e.jsx(pe,{className:"w-5 h-5"})," Add Image",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:n=>{n.target.files&&n.target.files[0]&&j(n.target.files[0])}})]}),e.jsx("button",{onClick:_,disabled:b||!c.trim(),className:"bg-black text-white px-5 py-2.5 rounded-full text-sm font-medium w-28 disabled:bg-gray-300",children:b?e.jsx(E,{className:"w-5 h-5 animate-spin mx-auto"}):"Submit"})]})]})};function Pe(){const{spotId:t}=K(),{user:l}=ee(),i=te(),[b,A]=r.useState(""),[p,v]=r.useState(0),[c,g]=r.useState([]),[f,j]=r.useState(!0),[h,N]=r.useState(!1),[D,_]=r.useState(!1),[n,d]=r.useState("createdAt"),[m,C]=r.useState("desc"),[y,k]=r.useState(!1),[w,u]=r.useState(null),[R,U]=r.useState(!1),L=10,T=(s=!1)=>{let o=B(V(S,"reviews"),re("spotId","==",t),le(n,m),ae(L));return s&&w&&(o=B(o,ne(w))),o},q=r.useCallback(async()=>{if(t){j(!0),g([]),u(null),U(!1);try{const s=H(S,"spots",t),o=await se(s);if(o.exists()){const $=o.data();A($.name||""),v($.reviewCount||0)}const x=T(),a=await z(x),F=a.docs.map($=>({id:$.id,...$.data()}));g(F),a.docs.length<L?U(!0):u(a.docs[a.docs.length-1])}catch(s){console.error("Error fetching initial data:",s)}finally{j(!1)}}},[t,n,m]);r.useEffect(()=>{q()},[q]);const J=async()=>{if(!(y||R||!w)){k(!0);try{const s=T(!0),o=await z(s),x=o.docs.map(a=>({id:a.id,...a.data()}));g(a=>[...a,...x]),o.docs.length<L?(U(!0),u(null)):u(o.docs[o.docs.length-1])}catch(s){console.error("Error loading more reviews:",s)}finally{k(!1)}}},Q=(s,o)=>{const x={...s,id:o,createdAt:new Date};g(a=>[x,...a]),v(a=>a+1),N(!1)},X=async(s,o,x)=>{try{g(a=>a.filter(F=>F.id!==s)),v(a=>Math.max(0,a-1))}catch(a){console.error("Failed to delete review:",a)}},Y=async(s,o)=>{if(!l)return!1;const x=H(S,"reviews",s);try{return await G(S,async a=>{a.update(x,{helpfulCount:oe(1)})}),!0}catch(a){return console.error("Failed to mark review helpful:",a),!1}},Z=s=>{s===n?C(o=>o==="desc"?"asc":"desc"):(d(s),C("desc"))};return e.jsxs("div",{className:"min-h-screen bg-gray-50 pb-10",children:[e.jsxs(P.div,{className:"bg-white shadow-sm py-3 px-4 sticky top-0 z-40 flex items-center gap-3",initial:{y:-20,opacity:0},animate:{y:0,opacity:1},children:[e.jsx("button",{onClick:()=>i(-1),className:"rounded-full p-2 -ml-2 hover:bg-gray-100","aria-label":"Go back",children:e.jsx(xe,{})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",children:b||"Reviews"}),e.jsxs("p",{className:"text-xs text-gray-500",children:[p," reviews"]})]})]}),e.jsxs("div",{className:"bg-white sticky top-[61px] z-30 border-b border-gray-100",children:[e.jsx("div",{className:"p-4",children:e.jsxs("button",{onClick:()=>{l?N(s=>!s):i("/login")},className:"w-full flex items-center justify-between p-3 bg-gray-100 rounded-xl","aria-expanded":h,children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:h?"Close form":"Write a review..."}),h?e.jsx(O,{className:"w-5 h-5"}):e.jsx(Ne,{className:"w-5 h-5"})]})}),e.jsx(he,{children:h&&e.jsx(_e,{spotId:t,user:l,onPostSuccess:Q,isPosting:D,setIsPosting:_})})]}),e.jsxs("div",{className:"px-4 pt-4 flex items-center gap-2 overflow-x-auto no-scrollbar",children:[e.jsx("span",{className:"text-sm font-medium text-gray-500 flex-shrink-0",children:"Sort by:"}),["createdAt","rating","helpfulCount"].map(s=>{const o=n===s;let x=s;return s==="createdAt"&&(x="Newest"),s==="rating"&&(x="Rating"),s==="helpfulCount"&&(x="Helpful"),e.jsxs("button",{onClick:()=>Z(s),className:`flex-shrink-0 px-3 py-1 text-sm rounded-full transition-colors ${o?"bg-black text-white font-semibold":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[x,o&&(m==="desc"?" ↓":" ↑")]},s)})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[f?e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx(I,{}),e.jsx(I,{})]}):c.length===0?e.jsxs("div",{className:"text-center text-gray-500 pt-10",children:[e.jsx(ve,{className:"w-12 h-12 mx-auto text-gray-300"}),e.jsx("h3",{className:"text-lg font-semibold mt-2",children:"No reviews yet"}),e.jsx("p",{className:"text-sm",children:"Be the first to share your experience!"})]}):c.map(s=>e.jsx(De,{review:s,user:l,onDeleteReview:X,onMarkHelpful:Y},s.id)),e.jsxs("div",{className:"pt-4 text-center",children:[y&&e.jsx(E,{className:"w-6 h-6 animate-spin mx-auto text-gray-500"}),!f&&!y&&!R&&c.length>0&&e.jsx("button",{onClick:J,className:"bg-black text-white px-6 py-2.5 rounded-full font-medium transition-opacity hover:opacity-80",children:"Load More"}),!f&&R&&c.length>L&&e.jsx("p",{className:"text-gray-500",children:"You've reached the end"})]})]})]})}export{Pe as default};
